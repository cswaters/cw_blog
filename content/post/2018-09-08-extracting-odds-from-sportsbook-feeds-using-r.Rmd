---
title: Extracting Odds from Sportsbook Feeds Using R
author: Cory Waters
date: '2018-09-08'
slug: extracting-odds-from-sportsbook-feeds-using-r
categories:
  - R
tags:
  - R
  - data
  - Odds
description: 'Json feeds are all alike; every XML feed is different in its own way.'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

## Finding Feeds

There's some sportsbooks' that post the address to their odds feed on the website. Other times it's an open secret. Either way, if you do a little digging you're going to find bookmaker feeds. (We're only interested in free feeds here, there's plenty of services you can pay for.)

### What format

Data is transfered over the net is many different forms. REST and JSON, (god forbid) SOAP, and XML are the formats you're likley to come across. For US facing books most seem to be using XML. XML is a topic worthy of a book itself. I'm not an expert. My personal opinion is XML is ugly and hard to work with compared to JSON. There's lot of people who think differently. In this example we're going to take XML and convert it to JSON.

### Converting Formats

The process for getting the data is `Download the XML file --> Convert the XML to JSON --> Load the JSON into R`. 

Most people will say that the step of converting the XML to json isn't necassary and a waste of resources. They're probably right. However, I loathe working with xml. And the conversion is less than one line and takes a second or less. If we were working on a large scale project in real time this wouldn't be an ideal solution. But we're downloading odds from one sportsbook, doing some cleanup work and exporting we can spend extra computing power without hurting ourselves.

+ To download the file we're going to use a tool named `cUrl`. There's an R package for curl but we're going to use the shell instead.
+ To convert the XML to JSON we're using a node.js package called `xml2json`[^fn1]. 
+ Then to load the JSON into R we're using the `jsonlite::fromJSON` function.

The `system` command in R let's the user call shell functions from inside R. This is helpful because we can keep all the code inside our R script even though we're making calls from the shell.

## Getting the odds

We're going to use [bookmaker.eu's](https://www.bookmaker.eu) line feed. A couple of minutes worth of googling and you could find it yourself. But I'll save you the trouble here. 

<http://lines.bookmaker.eu>

If you open the feed in your browser you'll see a big nested XML structure. There's not much you can do with it in this format. 

![bookmaker lines](https://dl.dropboxusercontent.com/s/od303emdkw9ba60/bookmaker.eu-lines.png)


```{r}
# Make a shell call to curl that downloads the xml file at the bookmaker feed address
# Then we pass that file to the xml2json command (the | means pass to)
# Finally we output the the data to the bkmkr.json file
system('curl -sL "http://lines.bookmaker.eu" | xml2json > bkmkr.json')

# Since we downloaded and converted the file in our working directory
# we can easily load the file into R with the fromJSON function
bkmkr <- jsonlite::fromJSON("bkmkr.json")
```

In R the `bkkmkr` object is a nested structure of lists of lists of lists of...

```{r}
typeof(bkmkr)
```

Normally you'd use the `str` or `glimpse` function to get an idea of the structure. But with these large nested lists that's basically useless. One way is to put a `$` at the end of the data object and see what autocomplete comes up with. Play with the object a little to identify a structure. It sounds crazy but it works.

In this case, when we look at `bkmkr` we find a data frame inside the list. This data frame contains list columns and other dataframes. But looking at the dataframe columns it's obvious this is some sort of master key or schema. After doing some more digging I came up with the follow dataframe.


```{r}
# show only the first 25 to save space
head(bkmkr$Data$Leagues$league, 25)

```

Each row represents a "league". A league is made up of a sport (`IdSport`) and a description (`Description`). 

Let's use NFL as an example. We'll find many rows with the `IdSport` of NFL, the actual bet type is identified by the `Description` column "NFL - FUTURES." For every NFL bet type there will be a `IdSport` column with NFL and a `Description` column with the type of bet. Those two combine to create a `IdLeague` (some number assigned by bookmaker.eu).

There's two other columns. `banner` and `game`. Without going into too much detail, `banner` is for bookmaker.eu's marketing. `game` is what we're interested in.

First let's take a look at the bets available to us.

```{r}
bkmkr$Data$Leagues$league$Description %>% 
  head(20)
```

There's a lot there so I'm cutting off at 20 but run it yourself to see everything bookmaker offers. 

### Extracting the data

To continue with the NFL theme let's pull the odds for NFL Futures.

The process:

1. Get the row with the NFL Futures and make note of it
2. Extract the odds data from the `game` column (which is a nested dataframe) from the NFL Futures row. We're going to learn the structure of the data and extract only the parts we want.
4. Return the odds as numeric money lines in a dataframe with the type of bet, rotation number, team, and odds.

### Step 1: Identify the row we need.

After looking at the vector of the `Description` column we see that the NFL Futures are listed as `NFL - FUTURES`. Save the row number to an object for later use.

```{r}
idx_props <-
  which(bkmkr$Data$Leagues$league$Description == "NFL - FUTURES")
```

### Step 2: Get the odds data from the `game` column

The first thing to notice when looking at the `game` column is that there's more nested structures inside it. We convert the column into a dataframe (a tibble in this case) but most of the data is useless for our needs. There's dates and id numbers, but we're only interested in the teams and odds.

```{r}
as_tibble(bkmkr$Data$Leagues$league$game[[idx_props]])
```


We're going to select the `htm` (short for home team I assume) and `line` columns (which is another dataframe nested column). Next we need to use the `unnest` function to reveal the data inside the `line` column.

```{r}
as_tibble(bkmkr$Data$Leagues$league$game[[idx_props]]) %>%
  select(htm, line) %>%
  unnest(line)
```

Finally we found our data. The team is under the `tmname` column. The bet type, for example "Odds to Win 2018 - Super Bowl LIII," is under `htm`, rotation numbers are in the `tmnum` column, and the odds are in the column `odds`.

### Step 3: Return the odds dataframe

We're selecting only the `htm`, `tmnum`, `tmname`, and `odds` columns. In the process rename the columns to something more useful (`select` allows you to rename columns while selecting them, a very useful feature). Last we convert the odds column into a numeric data type from character.

```{r}
as_tibble(bkmkr$Data$Leagues$league$game[[idx_props]]) %>%
  select(htm, line) %>%
  unnest(line) %>% 
  select(prop = htm,
         rot_num = tmnum,
         selection = tmname,
         odds) %>%
  mutate(odds = as.numeric(odds)
         ) 

```

Now it's possible to work with the data. Compare it to other lines, calculate the juice being charged, Track long term lines moves, etc.

### Putting it all together

The last thing we'll do is wrap up the code in a function for easy future use.


```{r}
get_bookmakereu_leagues <- function(){
  system('curl -sL "http://lines.bookmaker.eu" | xml2json > bkmkr.json')
  jsonlite::fromJSON("bkmkr.json")$Data$Leagues$league$Description
}

get_bookmakereu_leagues() %>% head(20)
```

After you know the description name of the odds you're looking for assign them to a variable

```{r}
# the order changes so it's better for me to do it this way but normally I'd use the
# index number
nfl_futures <- which(get_bookmakereu_leagues() == 'NFL - FUTURES')
```

Now we can list the odds.

```{r}
list_bookmakereu_odds <- function(league_idx){
  as_tibble(bkmkr$Data$Leagues$league$game[[league_idx]]) %>%
  select(htm, line) %>%
  unnest(line) %>%
  select(prop = htm,
         rot_num = tmnum,
         selection = tmname,
         odds) %>%
  mutate(odds = as.numeric(odds)) 
}

bookmaker_odds <- list_bookmakereu_odds(nfl_futures)
bookmaker_odds %>% knitr::kable()

```


[^fn1]: The package is old (in tech standards). And I'm not sure if it's being activley maintained anymore. But it works and other than having to install node.js (which if you take any of this programming stuff seriously you'll end up doing sooner than later). Go to <https://nodejs.org/en/download/> and download then install the most recent version of node. Then open up your terminal, and enter the command `npm install -g xml2json-command`

